<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
  <head>
    <script src="/js/color-modes.js"></script>
    <link rel="stylesheet" href="/bootstrap-icons-1.10.5/font/bootstrap-icons.min.css" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= title %></title>
    <link href="/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/dark-light.css" />
    <link href="/css/sidebars.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/myStyle.css" />
    <style>
      .settings-container {
        max-width: 900px;
        margin: 0 auto;
      }
      .settings-card {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      .settings-card h5 {
        margin-bottom: 20px;
        color: var(--bs-body-color);
        font-weight: 600;
      }
      .profile-photo-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 15px;
        border: 3px solid var(--bs-primary);
      }
    </style>
  </head>
  <body>
    <%- include('../components/dark-light.ejs') %>

    <main class="d-flex flex-nowrap">
      <%- include('../components/sidebar.ejs', {status: 'settings'}) %>

      <div class="container-fluid">
        <%- include('../components/navbar.ejs') %>

        <div class="settings-container">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0"><i class="bi bi-gear"></i> Account Settings</h2>
          </div>

          <% if (success && success.length > 0) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <i class="bi bi-check-circle-fill"></i> <%= success %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% } %>

          <% if (error && error.length > 0) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="bi bi-exclamation-triangle-fill"></i> <%= error %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% } %>

          <!-- Profile Photo Section -->
          <div class="settings-card">
            <h5><i class="bi bi-person-circle"></i> Profile Photo</h5>
            <div class="text-center mb-3">
              <img src="<%= user.profilePhoto %>" alt="Profile Photo" class="profile-photo-preview" id="photoPreview">
            </div>
            <form action="/account/photo" method="POST" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="profilePhoto" class="form-label">Choose new photo</label>
                <input 
                  type="file" 
                  class="form-control" 
                  id="profilePhoto" 
                  name="profilePhoto"
                  accept="image/*"
                  onchange="previewPhoto(event)"
                >
                <small class="text-muted">Accepted formats: JPG, PNG, GIF (Max 5MB)</small>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-upload"></i> Upload Photo
              </button>
            </form>
          </div>

          <!-- Account Information Section -->
          <div class="settings-card">
            <h5><i class="bi bi-person-badge"></i> Account Information</h5>
            <form action="/account/update" method="POST">
              <div class="mb-3">
                <label for="fullName" class="form-label">Full Name</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="fullName" 
                  name="fullName"
                  value="<%= user.fullName || '' %>"
                  placeholder="Enter your full name"
                >
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input 
                  type="email" 
                  class="form-control" 
                  id="email" 
                  name="email"
                  value="<%= user.email %>"
                  required
                >
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Save Changes
              </button>
            </form>
          </div>

          <!-- Change Password Section -->
          <div class="settings-card">
            <h5><i class="bi bi-shield-lock"></i> Change Password</h5>
            <form action="/account/password" method="POST" id="passwordForm">
              <div class="mb-3">
                <label for="currentPassword" class="form-label">Current Password</label>
                <div class="input-group">
                  <input 
                    type="password" 
                    class="form-control" 
                    id="currentPassword" 
                    name="currentPassword"
                    required
                    style="border-right: 0;"
                  >
                  <span class="input-group-text" onclick="togglePassword('currentPassword')" style="cursor: pointer; background: transparent; border-left: 0;">
                    <i class="bi bi-eye" id="currentPassword-icon"></i>
                  </span>
                </div>
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <div class="input-group">
                  <input 
                    type="password" 
                    class="form-control" 
                    id="newPassword" 
                    name="newPassword"
                    required
                    style="border-right: 0;"
                  >
                  <span class="input-group-text" onclick="togglePassword('newPassword')" style="cursor: pointer; background: transparent; border-left: 0;">
                    <i class="bi bi-eye" id="newPassword-icon"></i>
                  </span>
                </div>
                <small class="text-muted">
                  Must be at least 8 characters with uppercase, lowercase, number, and special character
                </small>
              </div>
              <div class="mb-3">
                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                <div class="input-group">
                  <input 
                    type="password" 
                    class="form-control" 
                    id="confirmPassword" 
                    name="confirmPassword"
                    required
                    style="border-right: 0;"
                  >
                  <span class="input-group-text" onclick="togglePassword('confirmPassword')" style="cursor: pointer; background: transparent; border-left: 0;">
                    <i class="bi bi-eye" id="confirmPassword-icon"></i>
                  </span>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-key"></i> Change Password
              </button>
            </form>
          </div>

          <!-- Account Info Display -->
          <div class="settings-card">
            <h5><i class="bi bi-info-circle"></i> Account Details</h5>
            <p><strong>Member Since:</strong> <%= new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></p>
            <p><strong>Account Status:</strong> <span class="badge bg-success">Active</span></p>
          </div>

        </div>
      </div>
    </main>

    <script src="/js/bootstrap.bundle.min.js"></script>
    <script>
      // Preview photo before upload
      function previewPhoto(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('photoPreview').src = e.target.result;
          }
          reader.readAsDataURL(file);
        }
      }

      // Toggle password visibility
      function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = document.getElementById(fieldId + '-icon');
        
        if (field.type === 'password') {
          field.type = 'text';
          icon.classList.remove('bi-eye');
          icon.classList.add('bi-eye-slash');
        } else {
          field.type = 'password';
          icon.classList.remove('bi-eye-slash');
          icon.classList.add('bi-eye');
        }
      }

      // Password validation
      const passwordForm = document.getElementById('passwordForm');
      passwordForm.addEventListener('submit', function(e) {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
          e.preventDefault();
          alert('New passwords do not match!');
          return false;
        }

        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        if (!passwordRegex.test(newPassword)) {
          e.preventDefault();
          alert('Password must be at least 8 characters long and contain at least one uppercase letter, one lowercase letter, one number, and one special character (@$!%*?&)');
          return false;
        }
      });
    </script>
  </body>
</html>
